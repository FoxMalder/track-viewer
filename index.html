<!DOCTYPE html>
<html>

<head>
    <title>IbGeo Map</title>
    <link rel="stylesheet" href="leaflet.css"/>
    <link rel="stylesheet" href="custom.css"/>
    <link rel="stylesheet" href="MarkerCluster.css"/>
    <link rel="stylesheet" href="https://code.jquery.com/ui/1.11.4/themes/smoothness/jquery-ui.css"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
    <meta charset="utf-8">
    
    <script src="jquery.min.js"></script>
    <script src="heap.js"></script>
	<script src="leaflet-src.js"></script>
	<script src="leaflet-indoor.js"></script>
	<script src="leaflet.markercluster.js"></script>
    <script src="http://contentsrv.ibecom.ru/tracker/socket.io/socket.io.js"></script>
    <script src="https://code.jquery.com/ui/1.11.4/jquery-ui.min.js"></script>   
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.12.0/moment.min.js"></script>  
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.12.0/locale/ru.js"></script>  
    <script src="TrackMap.js"></script> 
    <script src="Track.js"></script>
    <script src="TrackPlayer.js"></script>
    
    <script type="text/javascript">
       
		var appID = 3;
		
		// should be before loading ibgeomap.js because ibgeomap.js checks this flag immediatly
		window.appSideInit = true;
		
		moment.locale('ru');
				
		var socket = io.connect('http://contentsrv.ibecom.ru', {
				path : "/tracker/socket.io"
			}),
			map = new TrackMap(),
			trackPlayer = new TrackPlayer({
				map : map,
				onLoad : function(track) {
					
					console.log(track);
															
					$("#time_slider").slider("option", {
						min : track.getStartTime(),
						max : track.getEndTime(),
						disabled: false 
					});
				},
				onTimeChange : function(time) {
					var formattedDate = moment(time).format('DD.MM.YYYY HH:mm:ss');
					
					$("#time_ind").text("Время: " + formattedDate);
					$("#time_slider").slider("value", time);
				}
			});
				
		$(function() {
			
			socket.on('load-track', function (points) {
		        if (points.length === 0) {
		            return;
		        }
		        
		        $.each(points, function(i, point) {
		        	point.timestamp = parseInt(point.timestamp, 10);
		        });
		        
		        trackPlayer.load(new Track(points));
		        trackPlayer.play();
		    });
						
			$.getJSON('map_canvas.json',
					function(mapdata) {
						initMap({
							higlightableTag : 'zone',
							labelHideZoom : 17,
							minZoom : 17,
							maxZoom : 28,
							zoom : 17,
							fitBounds : true
						});
						loadMapCanvas(mapdata);
					});	
			
			$('#play_button').button({
		        icons: {
		          primary: "ui-icon-play"
		        },
		        text: false
		    }).click(function() {
		    	
		    	socket.emit('load-track', {
		            appId: 3,
		            startTimeStamp: Date.parse("29 Dec 2015 17:32 UTC+3"),
		            endTimeStamp: Date.parse("29 Dec 2015 17:37 UTC+3")
		        });
		    	
		    });
			
			
			function setSpeedIndValue(value) {
				$("#speed_ind").text("Скорость: " + value + "x");
			}
		    
			$("#speed_slider").slider({
					value : 1,
					min : 1,
					max : 20,
					slide : function(event, ui) {
						var speed = ui.value;
						
						setSpeedIndValue(speed);
						trackPlayer.setSpeed(speed);
					}
				});
			setSpeedIndValue($("#speed_slider").slider("value"));
			
			
			$("#time_slider").slider({
				min : 0,
				max : 1,
				slide : function(event, ui) {
					var time = ui.value;
					trackPlayer.setCurrentTime(time);
				},
				disabled : true
			});
			
			
			

		});
	</script>
	<script src="ibgeomap.js"></script>
	
	<style type="text/css">
		.main_container {
			width: 100%;
			height: 100%;
		}
		
		.left_panel {
			width: 400px;
			height: 100%;
			float: left;
			margin: 15px;
			font-family: "Trebuchet MS", "Helvetica", "Arial",  "Verdana", "sans-serif";
			font-size: 62.5%;
		}
		
		.rigth_panel {
			height: 100%;
			overflow: hidden;
		}
		
		.ui-slider {
			margin-bottom: 10px;
		}
				
	</style>
    
</head>
<body>

	<div class="main_container">
		<div class="left_panel">
			<p id="time_ind">Время: __.__.__ __:__</p>
			<div id="time_slider"></div>
		
			<div>
				<button id="play_button">Воспроизведение</button>
			</div>
			
			<p id="speed_ind"></p>
			<div id="speed_slider"></div>
		</div>
		<div id="map" class="right_panel"></div>
	</div>

</body>
</html>
